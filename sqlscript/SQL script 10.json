{
	"name": "SQL script 10",
	"properties": {
		"folder": {
			"name": "Files to Name"
		},
		"content": {
			"query": "/* Script below walks through some queries to clean up and narrow \ndown the data from the external table.  This will allow us \nto filter and clean up what's sent to Power BI report. \n**** Make sure to change the context of the database before you run \nthe script below.  USE statement doesn't seem to work in studio like SSMS/etc****\n\nThe code below is meant to be stepped through for understanding.  \nFinal 2 queries pertain to building and querying the final view. \n\n*/ \n\n\nuse vitalsource;\nGO \nselect\n  [@context] as \"Version\",\n\t[action],\n\t[actor],\n\t[edApp],\n\t[eventTime],\n\t[object],\n\t[session],\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\n  from VitalSourceEvents\nGO \n\n/* Here's an example to clean up the data that's still \nin JSON format */ \n\nselect \nactor,\nJSON_VALUE(actor,'$.id') AS 'ActorID'\nfrom VitalSourceEvents\n\n/* Full SQL cleanup for a view */ \n\nselect top 10 \n[@context] as \"Version\",\n\t[action],\n\t[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\n  from VitalSourceEvents\n  --where \n\n\n\n\n\nWITH cte_pull_raw AS (\n select top 10 \n[@context] as \"Version\",\n\t[action],\n\t[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\n  from VitalSourceEvents\n\n)\n\nSELECT\n [Version],\n\t[action],\n\t--[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t--[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t--[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t--[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\nFROM \n    cte_pull_raw\n/*\n    WHERE\n    year = 2018;\n*/ \n\n\nDROP VIEW IF EXISTS EventsView;\nGO\n\nCREATE VIEW EventsView\nAS \n  WITH cte_pull_raw AS (\n select top 10 \n[@context] as \"Version\",\n\t[action],\n\t[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\n  from VitalSourceEvents\n\n)\n\nSELECT\n [Version],\n\t[action],\n\t--[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t--[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t--[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t--[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\nFROM \n    cte_pull_raw\n/*\n    WHERE\n    year = 2018;\n*/ \n\n\nselect * from EventsView\n\n\n/* \nALTER VIEW EventsView\nas \nWITH cte_pull_raw AS (\n select top 10 \n[@context] as \"Version\",\n\t[action],\n\t[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\n  from VitalSourceEvents\n\n)\n\nSELECT\n [Version],\n\t[action],\n\t--[actor],\n  JSON_VALUE(actor,'$.id') AS 'ActorID',\n\t--[edApp],\n  JSON_VALUE(edApp,'$.type') AS 'EdAppType',\n\t[eventTime],\n\t--[object],\n  JSON_VALUE(object,'$.id') AS 'BookID',\n  JSON_VALUE(object,'$.isPartOf.type') AS 'ObjectType',\n  JSON_VALUE(object,'$.name') AS 'PageNum',\n  JSON_VALUE(object,'$.type') AS 'PageType',\n\t--[session],\n  JSON_VALUE(session,'$.id') AS 'SessionID',\n\t[type],\n\t[id],\n\t[dataVersion],\n\t[sendTime],\n\t[sensor],\n\t[VitalSrcFileProcessed]\nFROM \n    cte_pull_raw\n\n    WHERE\n    year = 2018;\n\n\n  /* \n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			}
		},
		"type": "SqlQuery"
	}
}